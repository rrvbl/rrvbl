<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Volleyball Database</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/supabase/2.38.0/umd/supabase.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
            color: white;
            font-size: 2.5em;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        /* Navigation */
        nav {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .nav-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .nav-btn.active {
            background: rgba(255, 255, 255, 0.4);
            font-weight: bold;
        }

        /* Main Content */
        .main-content {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .section {
            display: none;
            animation: fadeIn 0.5s ease-in;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Home Page Sections */
        .home-section {
            margin-bottom: 40px;
        }

        .home-section h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.8em;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .player-grid, .transfer-grid, .match-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }

        .player-card, .transfer-card, .match-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .player-card:hover, .transfer-card:hover, .match-card:hover {
            transform: translateY(-5px);
        }

        .player-image, .team-image {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 15px;
        }

        /* Forms */
        .form-container {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-danger {
            background: #dc3545;
        }

        /* Search */
        .search-container {
            margin-bottom: 30px;
        }

        .search-input {
            width: 100%;
            padding: 15px;
            font-size: 18px;
            border: 2px solid #667eea;
            border-radius: 10px;
        }

        /* Player/Team Lists */
        .item-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .item-card {
            background: #fff;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #667eea;
        }

        .error {
            color: #dc3545;
            font-size: 14px;
            margin-top: 5px;
        }

        .success {
            color: #28a745;
            font-size: 14px;
            margin-top: 5px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            nav {
                gap: 10px;
            }
            
            .nav-btn {
                padding: 10px 15px;
                font-size: 14px;
            }
            
            .main-content {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üèê Volleyball Database</h1>
            <nav>
                <button class="nav-btn active" onclick="showSection('home')">Home</button>
                <button class="nav-btn" onclick="showSection('players')">Players</button>
                <button class="nav-btn" onclick="showSection('search')">Search</button>
                <button class="nav-btn" onclick="showSection('teams')">Teams</button>
                <button class="nav-btn" onclick="showSection('transfers')">Transfers</button>
                <button class="nav-btn" onclick="showSection('add')">Add New Item</button>
            </nav>
        </header>

        <div class="main-content">
            <!-- Home Section -->
            <div id="home" class="section active">
                <div class="home-section">
                    <h2>üÜï Recently Added Players</h2>
                    <div id="recent-players" class="player-grid"></div>
                </div>
                
                <div class="home-section">
                    <h2>üîÑ Recent Transfers</h2>
                    <div id="recent-transfers" class="transfer-grid"></div>
                </div>
                
                <div class="home-section">
                    <h2>üèÜ Recent Match Scores</h2>
                    <div id="recent-matches" class="match-grid"></div>
                </div>
            </div>

            <!-- Players Section -->
            <div id="players" class="section">
                <h2>All Players</h2>
                <div class="search-container">
                    <input type="text" class="search-input" placeholder="Search players..." onkeyup="searchPlayers(this.value)">
                </div>
                <div id="players-list" class="item-list"></div>
            </div>

            <!-- Search Section -->
            <div id="search" class="section">
                <h2>Search Database</h2>
                <div class="search-container">
                    <input type="text" class="search-input" placeholder="Search players, teams, or transfers..." onkeyup="globalSearch(this.value)">
                </div>
                <div id="search-results" class="item-list"></div>
            </div>

            <!-- Teams Section -->
            <div id="teams" class="section">
                <h2>All Teams</h2>
                <div class="search-container">
                    <input type="text" class="search-input" placeholder="Search teams..." onkeyup="searchTeams(this.value)">
                </div>
                <div id="teams-list" class="item-list"></div>
            </div>

            <!-- Transfers Section -->
            <div id="transfers" class="section">
                <h2>All Transfers</h2>
                <div id="transfers-list" class="item-list"></div>
            </div>

            <!-- Add New Item Section -->
            <div id="add" class="section">
                <h2>Add New Item</h2>
                <div style="margin-bottom: 20px;">
                    <button class="btn" onclick="showAddForm('player')">Add Player</button>
                    <button class="btn" onclick="showAddForm('team')">Add Team</button>
                    <button class="btn" onclick="showAddForm('transfer')">Add Transfer</button>
                    <button class="btn" onclick="showAddForm('match')">Add Match Score</button>
                </div>

                <!-- Add Player Form -->
                <div id="add-player-form" class="form-container" style="display: none;">
                    <h3>Add New Player</h3>
                    <form onsubmit="addPlayer(event)">
                        <div class="form-group">
                            <label>Player Name:</label>
                            <input type="text" name="name" required>
                        </div>
                        <div class="form-group">
                            <label>Player Image (optional):</label>
                            <div style="margin-bottom: 10px;">
                                <input type="radio" name="image_type" value="url" id="player-url" checked>
                                <label for="player-url" style="display: inline; margin-left: 5px;">URL</label>
                                <input type="radio" name="image_type" value="upload" id="player-upload" style="margin-left: 15px;">
                                <label for="player-upload" style="display: inline; margin-left: 5px;">Upload</label>
                            </div>
                            <input type="url" name="image_url" placeholder="Enter image URL" style="display: block;">
                            <input type="file" name="image_file" accept="image/*" style="display: none;">
                        </div>
                        <div class="form-group">
                            <label>Gender:</label>
                            <select name="gender" required>
                                <option value="">Select Gender</option>
                                <option value="male">Male</option>
                                <option value="female">Female</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Position:</label>
                            <select name="position" required>
                                <option value="">Select Position</option>
                                <option value="wing spiker">Wing Spiker</option>
                                <option value="middle blocker">Middle Blocker</option>
                                <option value="setter">Setter</option>
                                <option value="libero">Libero</option>
                                <option value="defensive specialist">Defensive Specialist</option>
                                <option value="all rounder">All Rounder</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Team:</label>
                            <select name="team" id="player-team-select" required>
                                <option value="">Select Team</option>
                            </select>
                            <button type="button" class="btn btn-secondary" onclick="showQuickAddTeam()">Add New Team</button>
                        </div>
                        <button type="submit" class="btn">Add Player</button>
                        <button type="button" class="btn btn-secondary" onclick="hideAddForms()">Cancel</button>
                    </form>
                    <div id="player-form-message"></div>
                </div>

                <!-- Add Team Form -->
                <div id="add-team-form" class="form-container" style="display: none;">
                    <h3>Add New Team</h3>
                    <form onsubmit="addTeam(event)">
                        <div class="form-group">
                            <label>Team Name:</label>
                            <input type="text" name="name" required>
                        </div>
                        <div class="form-group">
                            <label>Team Logo (optional):</label>
                            <div style="margin-bottom: 10px;">
                                <input type="radio" name="logo_type" value="url" id="team-url" checked>
                                <label for="team-url" style="display: inline; margin-left: 5px;">URL</label>
                                <input type="radio" name="logo_type" value="upload" id="team-upload" style="margin-left: 15px;">
                                <label for="team-upload" style="display: inline; margin-left: 5px;">Upload</label>
                            </div>
                            <input type="url" name="logo_url" placeholder="Enter logo URL" style="display: block;">
                            <input type="file" name="logo_file" accept="image/*" style="display: none;">
                        </div>
                        <div class="form-group">
                            <label>League:</label>
                            <select name="league" required>
                                <option value="">Select League</option>
                                <option value="2v2">2v2</option>
                                <option value="4v4">4v4</option>
                                <option value="5v5">5v5</option>
                            </select>
                        </div>
                        <button type="submit" class="btn">Add Team</button>
                        <button type="button" class="btn btn-secondary" onclick="hideAddForms()">Cancel</button>
                    </form>
                    <div id="team-form-message"></div>
                </div>

                <!-- Add Transfer Form -->
                <div id="add-transfer-form" class="form-container" style="display: none;">
                    <h3>Add Transfer</h3>
                    <form onsubmit="addTransfer(event)">
                        <div class="form-group">
                            <label>Player:</label>
                            <select name="player" id="transfer-player-select" required>
                                <option value="">Select Player</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>New Team:</label>
                            <select name="new_team" id="transfer-team-select" required>
                                <option value="">Select Team</option>
                            </select>
                        </div>
                        <button type="submit" class="btn">Add Transfer</button>
                        <button type="button" class="btn btn-secondary" onclick="hideAddForms()">Cancel</button>
                    </form>
                    <div id="transfer-form-message"></div>
                </div>

                <!-- Add Match Form -->
                <div id="add-match-form" class="form-container" style="display: none;">
                    <h3>Add Match Score</h3>
                    <form onsubmit="addMatch(event)">
                        <div class="form-group">
                            <label>Team 1:</label>
                            <select name="team1" required>
                                <option value="">Select Team 1</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Team 1 Score:</label>
                            <input type="number" name="team1_score" min="0" required>
                        </div>
                        <div class="form-group">
                            <label>Team 2:</label>
                            <select name="team2" required>
                                <option value="">Select Team 2</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Team 2 Score:</label>
                            <input type="number" name="team2_score" min="0" required>
                        </div>
                        <div class="form-group">
                            <label>Match Date:</label>
                            <input type="date" name="match_date" required>
                        </div>
                        <button type="submit" class="btn">Add Match</button>
                        <button type="button" class="btn btn-secondary" onclick="hideAddForms()">Cancel</button>
                    </form>
                    <div id="match-form-message"></div>
                </div>

                <!-- Quick Add Team Modal -->
                <div id="quick-add-team" class="form-container" style="display: none;">
                    <h3>Quick Add Team</h3>
                    <form onsubmit="quickAddTeam(event)">
                        <div class="form-group">
                            <label>Team Name:</label>
                            <input type="text" name="name" required>
                        </div>
                        <div class="form-group">
                            <label>League:</label>
                            <select name="league" required>
                                <option value="">Select League</option>
                                <option value="2v2">2v2</option>
                                <option value="4v4">4v4</option>
                                <option value="5v5">5v5</option>
                            </select>
                        </div>
                        <button type="submit" class="btn">Add Team</button>
                        <button type="button" class="btn btn-secondary" onclick="hideQuickAddTeam()">Cancel</button>
                    </form>
                    <div id="quick-team-message"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://mespelpryubyjddadruu.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1lc3BlbHByeXVieWpkZGFkcnV1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE5OTczNTMsImV4cCI6MjA2NzU3MzM1M30.Vb8kivvLXJ6t1-zcOiG_24e4EWR67IFwwOpUkcykREg';
        
        // Initialize Supabase client
        const supabase = supabase?.createClient ? supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY) : null;

        // Global variables
        let players = [];
        let teams = [];
        let transfers = [];
        let matches = [];

        // Initialize the application
        async function init() {
            if (!supabase) {
                console.error('Supabase not initialized. Please add your Supabase URL and API key.');
                showError('Please configure Supabase credentials in the code.');
                return;
            }
            
            await loadData();
            updateUI();
        }

        // Load all data from Supabase
        async function loadData() {
            try {
                const [playersData, teamsData, transfersData, matchesData] = await Promise.all([
                    supabase.from('players').select('*').order('created_at', { ascending: false }),
                    supabase.from('teams').select('*').order('created_at', { ascending: false }),
                    supabase.from('transfers').select('*, players(name), teams(name)').order('created_at', { ascending: false }),
                    supabase.from('matches').select('*, team1:teams!matches_team1_fkey(name), team2:teams!matches_team2_fkey(name)').order('match_date', { ascending: false })
                ]);

                players = playersData.data || [];
                teams = teamsData.data || [];
                transfers = transfersData.data || [];
                matches = matchesData.data || [];
            } catch (error) {
                console.error('Error loading data:', error);
                showError('Error loading data from database.');
            }
        }

        // Update UI with current data
        function updateUI() {
            updateHomePage();
            updatePlayersPage();
            updateTeamsPage();
            updateTransfersPage();
            updateFormSelects();
        }

        // Update home page sections
        function updateHomePage() {
            // Recent players (last 5)
            const recentPlayers = players.slice(0, 5);
            document.getElementById('recent-players').innerHTML = recentPlayers.map(player => `
                <div class="player-card">
                    ${player.image ? `<img src="${player.image}" alt="${player.name}" class="player-image">` : ''}
                    <h3>${player.name}</h3>
                    <p><strong>Position:</strong> ${player.position}</p>
                    <p><strong>Gender:</strong> ${player.gender}</p>
                    <p><strong>Team:</strong> ${getTeamName(player.team_id)}</p>
                </div>
            `).join('');

            // Recent transfers (last 5)
            const recentTransfers = transfers.slice(0, 5);
            document.getElementById('recent-transfers').innerHTML = recentTransfers.map(transfer => `
                <div class="transfer-card">
                    <h3>${transfer.players?.name || 'Unknown Player'}</h3>
                    <p><strong>From:</strong> ${getTeamName(transfer.from_team_id)}</p>
                    <p><strong>To:</strong> ${getTeamName(transfer.to_team_id)}</p>
                    <p><strong>Date:</strong> ${new Date(transfer.created_at).toLocaleDateString()}</p>
                </div>
            `).join('');

            // Recent matches (last 5)
            const recentMatches = matches.slice(0, 5);
            document.getElementById('recent-matches').innerHTML = recentMatches.map(match => `
                <div class="match-card">
                    <h3>${match.team1?.name || 'Team 1'} vs ${match.team2?.name || 'Team 2'}</h3>
                    <p><strong>Score:</strong> ${match.team1_score} - ${match.team2_score}</p>
                    <p><strong>Date:</strong> ${new Date(match.match_date).toLocaleDateString()}</p>
                </div>
            `).join('');
        }

        // Update players page
        function updatePlayersPage() {
            const playersWithTeams = players.map(player => ({
                ...player,
                teamName: getTeamName(player.team_id)
            }));

            document.getElementById('players-list').innerHTML = playersWithTeams.map(player => `
                <div class="item-card">
                    ${player.image ? `<img src="${player.image}" alt="${player.name}" class="player-image">` : ''}
                    <h3>${player.name}</h3>
                    <p><strong>Position:</strong> ${player.position}</p>
                    <p><strong>Gender:</strong> ${player.gender}</p>
                    <p><strong>Team:</strong> ${player.teamName}</p>
                </div>
            `).join('');
        }

        // Update teams page
        function updateTeamsPage() {
            const teamsWithMembers = teams.map(team => ({
                ...team,
                members: players.filter(p => p.team_id === team.id)
            }));

            document.getElementById('teams-list').innerHTML = teamsWithMembers.map(team => `
                <div class="item-card">
                    ${team.logo ? `<img src="${team.logo}" alt="${team.name}" class="team-image">` : ''}
                    <h3>${team.name}</h3>
                    <p><strong>League:</strong> ${team.league}</p>
                    <p><strong>Members:</strong> ${team.members.length}</p>
                    <div style="margin-top: 10px;">
                        <strong>Team Members:</strong>
                        <ul style="margin-left: 20px; margin-top: 5px;">
                            ${team.members.map(member => `<li>${member.name} (${member.position})</li>`).join('')}
                        </ul>
                    </div>
                </div>
            `).join('');
        }

        // Update transfers page
        function updateTransfersPage() {
            document.getElementById('transfers-list').innerHTML = transfers.map(transfer => `
                <div class="item-card">
                    <h3>${transfer.players?.name || 'Unknown Player'}</h3>
                    <p><strong>From:</strong> ${getTeamName(transfer.from_team_id)}</p>
                    <p><strong>To:</strong> ${getTeamName(transfer.to_team_id)}</p>
                    <p><strong>Date:</strong> ${new Date(transfer.created_at).toLocaleDateString()}</p>
                </div>
            `).join('');
        }

        // Update form selects
        function updateFormSelects() {
            const teamOptions = teams.map(team => 
                `<option value="${team.id}">${team.name} (${team.league})</option>`
            ).join('');

            const playerOptions = players.map(player => 
                `<option value="${player.id}">${player.name} - ${getTeamName(player.team_id)}</option>`
            ).join('');

            // Update all team selects
            document.querySelectorAll('#player-team-select, #transfer-team-select, [name="team1"], [name="team2"]').forEach(select => {
                const currentValue = select.value;
                select.innerHTML = '<option value="">Select Team</option>' + teamOptions;
                select.value = currentValue;
            });

            // Update player select
            const playerSelect = document.getElementById('transfer-player-select');
            if (playerSelect) {
                const currentValue = playerSelect.value;
                playerSelect.innerHTML = '<option value="">Select Player</option>' + playerOptions;
                playerSelect.value = currentValue;
            }
        }

        // Helper function to get team name by ID
        function getTeamName(teamId) {
            const team = teams.find(t => t.id === teamId);
            return team ? team.name : 'Unknown Team';
        }

        // Image upload and radio button handling
        document.addEventListener('change', function(e) {
            if (e.target.name === 'image_type') {
                const form = e.target.closest('form');
                const urlInput = form.querySelector('input[name="image_url"]');
                const fileInput = form.querySelector('input[name="image_file"]');
                
                if (e.target.value === 'url') {
                    urlInput.style.display = 'block';
                    fileInput.style.display = 'none';
                    fileInput.value = '';
                } else {
                    urlInput.style.display = 'none';
                    fileInput.style.display = 'block';
                    urlInput.value = '';
                }
            }
            
            if (e.target.name === 'logo_type') {
                const form = e.target.closest('form');
                const urlInput = form.querySelector('input[name="logo_url"]');
                const fileInput = form.querySelector('input[name="logo_file"]');
                
                if (e.target.value === 'url') {
                    urlInput.style.display = 'block';
                    fileInput.style.display = 'none';
                    fileInput.value = '';
                } else {
                    urlInput.style.display = 'none';
                    fileInput.style.display = 'block';
                    urlInput.value = '';
                }
            }
        });

        // Upload image to Supabase Storage
        async function uploadImage(file, folder = 'images') {
            if (!file) return null;
            
            const fileExt = file.name.split('.').pop();
            const fileName = `${Date.now()}-${Math.random().toString(36).substring(2)}.${fileExt}`;
            const filePath = `${folder}/${fileName}`;
            
            try {
                const { data, error } = await supabase.storage
                    .from('volleyball-images')
                    .upload(filePath, file);
                
                if (error) throw error;
                
                // Get public URL
                const { data: publicData } = supabase.storage
                    .from('volleyball-images')
                    .getPublicUrl(filePath);
                
                return publicData.publicUrl;
            } catch (error) {
                console.error('Error uploading image:', error);
                throw error;
            }
        }
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById(sectionId).classList.add('active');
            event.target.classList.add('active');
        }

        // Add form functions
        function showAddForm(formType) {
            hideAddForms();
            document.getElementById(`add-${formType}-form`).style.display = 'block';
            updateFormSelects();
        }

        function hideAddForms() {
            document.querySelectorAll('.form-container').forEach(form => {
                form.style.display = 'none';
            });
        }

        function showQuickAddTeam() {
            document.getElementById('quick-add-team').style.display = 'block';
        }

        function hideQuickAddTeam() {
            document.getElementById('quick-add-team').style.display = 'none';
        }

        // Add player function
        async function addPlayer(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            
            let imageUrl = null;
            
            // Handle image upload or URL
            const imageType = formData.get('image_type');
            if (imageType === 'url') {
                imageUrl = formData.get('image_url');
            } else if (imageType === 'upload') {
                const imageFile = formData.get('image_file');
                if (imageFile && imageFile.size > 0) {
                    try {
                        imageUrl = await uploadImage(imageFile, 'players');
                    } catch (error) {
                        showError('player-form-message', 'Error uploading image: ' + error.message);
                        return;
                    }
                }
            }
            
            const playerData = {
                name: formData.get('name'),
                image: imageUrl,
                gender: formData.get('gender'),
                position: formData.get('position'),
                team_id: formData.get('team')
            };

            try {
                const { data, error } = await supabase
                    .from('players')
                    .insert([playerData]);

                if (error) throw error;

                showSuccess('player-form-message', 'Player added successfully!');
                event.target.reset();
                await loadData();
                updateUI();
            } catch (error) {
                console.error('Error adding player:', error);
                showError('player-form-message', 'Error adding player: ' + error.message);
            }
        }

        // Add team function
        async function addTeam(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            
            let logoUrl = null;
            
            // Handle logo upload or URL
            const logoType = formData.get('logo_type');
            if (logoType === 'url') {
                logoUrl = formData.get('logo_url');
            } else if (logoType === 'upload') {
                const logoFile = formData.get('logo_file');
                if (logoFile && logoFile.size > 0) {
                    try {
                        logoUrl = await uploadImage(logoFile, 'teams');
                    } catch (error) {
                        showError('team-form-message', 'Error uploading logo: ' + error.message);
                        return;
                    }
                }
            }
            
            const teamData = {
                name: formData.get('name'),
                logo: logoUrl,
                league: formData.get('league')
            };

            try {
                const { data, error } = await supabase
                    .from('teams')
                    .insert([teamData]);

                if (error) throw error;

                showSuccess('team-form-message', 'Team added successfully!');
                event.target.reset();
                await loadData();
                updateUI();
            } catch (error) {
                console.error('Error adding team:', error);
                showError('team-form-message', 'Error adding team: ' + error.message);
            }
        }

        // Quick add team function
        async function quickAddTeam(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const teamData = {
                name: formData.get('name'),
                league: formData.get('league')
            };

            try {
                const { data, error } = await supabase
                    .from('teams')
                    .insert([teamData]);

                if (error) throw error;

                showSuccess('quick-team-message', 'Team added successfully!');
                event.target.reset();
                await loadData();
                updateFormSelects();
                hideQuickAddTeam();
            } catch (error) {
                console.error('Error adding team:', error);
                showError('quick-team-message', 'Error adding team: ' + error.message);
            }
        }

        // Add transfer function
        async function addTransfer(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const playerId = formData.get('player');
            const newTeamId = formData.get('new_team');

            // Get current team of player
            const player = players.find(p => p.id == playerId);
            if (!player) {
                showError('transfer-form-message', 'Player not found!');
                return;
            }

            const transferData = {
                player_id: playerId,
                from_team_id: player.team_id,
                to_team_id: newTeamId
            };

            try {
                // Add transfer record
                const { data: transferResult, error: transferError } = await supabase
                    .from('transfers')
                    .insert([transferData]);

                if (transferError) throw transferError;

                // Update player's team
                const { data: playerResult, error: playerError } = await supabase
                    .from('players')
                    .update({ team_id: newTeamId })
                    .eq('id', playerId);

                if (playerError) throw playerError;

                showSuccess('transfer-form-message', 'Transfer added successfully!');
                event.target.reset();
                await loadData();
                updateUI();
            } catch (error) {
                console.error('Error adding transfer:', error);
                showError('transfer-form-message', 'Error adding transfer: ' + error.message);
            }
        }

        // Add match function
        async function addMatch(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const matchData = {
                team1_id: formData.get('team1'),
                team1_score: parseInt(formData.get('team1_score')),
                team2_id: formData.get('team2'),
                team2_score: parseInt(formData.get('team2_score')),
                match_date: formData.get('match_date')
            };

            try {
                const { data, error } = await supabase
                    .from('matches')
                    .insert([matchData]);

                if (error) throw error;

                showSuccess('match-form-message', 'Match added successfully!');
                event.target.reset();
                await loadData();
                updateUI();
            } catch (error) {
                console.error('Error adding match:', error);
                showError('match-form-message', 'Error adding match: ' + error.message);
            }
        }

        // Search functions
        function searchPlayers(query) {
            const filtered = players.filter(player => 
                player.name.toLowerCase().includes(query.toLowerCase()) ||
                player.position.toLowerCase().includes(query.toLowerCase()) ||
                getTeamName(player.team_id).toLowerCase().includes(query.toLowerCase())
            );

            const playersWithTeams = filtered.map(player => ({
                ...player,
                teamName: getTeamName(player.team_id)
            }));

            document.getElementById('players-list').innerHTML = playersWithTeams.map(player => `
                <div class="item-card">
                    ${player.image ? `<img src="${player.image}" alt="${player.name}" class="player-image">` : ''}
                    <h3>${player.name}</h3>
                    <p><strong>Position:</strong> ${player.position}</p>
                    <p><strong>Gender:</strong> ${player.gender}</p>
                    <p><strong>Team:</strong> ${player.teamName}</p>
                </div>
            `).join('');
        }

        function searchTeams(query) {
            const filtered = teams.filter(team => 
                team.name.toLowerCase().includes(query.toLowerCase()) ||
                team.league.toLowerCase().includes(query.toLowerCase())
            );

            const teamsWithMembers = filtered.map(team => ({
                ...team,
                members: players.filter(p => p.team_id === team.id)
            }));

            document.getElementById('teams-list').innerHTML = teamsWithMembers.map(team => `
                <div class="item-card">
                    ${team.logo ? `<img src="${team.logo}" alt="${team.name}" class="team-image">` : ''}
                    <h3>${team.name}</h3>
                    <p><strong>League:</strong> ${team.league}</p>
                    <p><strong>Members:</strong> ${team.members.length}</p>
                    <div style="margin-top: 10px;">
                        <strong>Team Members:</strong>
                        <ul style="margin-left: 20px; margin-top: 5px;">
                            ${team.members.map(member => `<li>${member.name} (${member.position})</li>`).join('')}
                        </ul>
                    </div>
                </div>
            `).join('');
        }

        function globalSearch(query) {
            if (!query.trim()) {
                document.getElementById('search-results').innerHTML = '';
                return;
            }

            const results = [];

            // Search players
            const filteredPlayers = players.filter(player => 
                player.name.toLowerCase().includes(query.toLowerCase()) ||
                player.position.toLowerCase().includes(query.toLowerCase())
            );

            filteredPlayers.forEach(player => {
                results.push({
                    type: 'Player',
                    content: `
                        <div class="item-card">
                            ${player.image ? `<img src="${player.image}" alt="${player.name}" class="player-image">` : ''}
                            <h3>${player.name} <span style="color: #667eea;">(Player)</span></h3>
                            <p><strong>Position:</strong> ${player.position}</p>
                            <p><strong>Gender:</strong> ${player.gender}</p>
                            <p><strong>Team:</strong> ${getTeamName(player.team_id)}</p>
                        </div>
                    `
                });
            });

            // Search teams
            const filteredTeams = teams.filter(team => 
                team.name.toLowerCase().includes(query.toLowerCase()) ||
                team.league.toLowerCase().includes(query.toLowerCase())
            );

            filteredTeams.forEach(team => {
                const members = players.filter(p => p.team_id === team.id);
                results.push({
                    type: 'Team',
                    content: `
                        <div class="item-card">
                            ${team.logo ? `<img src="${team.logo}" alt="${team.name}" class="team-image">` : ''}
                            <h3>${team.name} <span style="color: #667eea;">(Team)</span></h3>
                            <p><strong>League:</strong> ${team.league}</p>
                            <p><strong>Members:</strong> ${members.length}</p>
                        </div>
                    `
                });
            });

            // Search transfers
            const filteredTransfers = transfers.filter(transfer => 
                transfer.players?.name?.toLowerCase().includes(query.toLowerCase())
            );

            filteredTransfers.forEach(transfer => {
                results.push({
                    type: 'Transfer',
                    content: `
                        <div class="item-card">
                            <h3>${transfer.players?.name || 'Unknown Player'} <span style="color: #667eea;">(Transfer)</span></h3>
                            <p><strong>From:</strong> ${getTeamName(transfer.from_team_id)}</p>
                            <p><strong>To:</strong> ${getTeamName(transfer.to_team_id)}</p>
                            <p><strong>Date:</strong> ${new Date(transfer.created_at).toLocaleDateString()}</p>
                        </div>
                    `
                });
            });

            document.getElementById('search-results').innerHTML = results.map(result => result.content).join('');
        }

        // Utility functions
        function showError(elementId, message) {
            const element = document.getElementById(elementId);
            if (element) {
                element.innerHTML = `<div class="error">${message}</div>`;
            } else {
                console.error(message);
            }
        }

        function showSuccess(elementId, message) {
            const element = document.getElementById(elementId);
            if (element) {
                element.innerHTML = `<div class="success">${message}</div>`;
            }
        }

        // Initialize the application when the page loads
        window.addEventListener('load', init);

        // Setup instructions for Supabase
        if (!supabase || SUPABASE_URL === 'https://mespelpryubyjddadruu.supabase.co') {
            console.log(`
                üèê Volleyball Database Setup Instructions:
                
                1. Create a free Supabase account at https://supabase.com
                
                2. Create a new project and get your URL and anon key
                
                3. Replace the following variables in the code:
                   - SUPABASE_URL: Your Supabase project URL
                   - SUPABASE_ANON_KEY: Your Supabase anon/public key
                
                4. Create a storage bucket for images:
                   - Go to Storage in your Supabase dashboard
                   - Create a new bucket named "volleyball-images"
                   - Make it public or set appropriate policies
                
                5. Create the following tables in your Supabase SQL editor:
                
                -- Create teams table
                CREATE TABLE teams (
                    id SERIAL PRIMARY KEY,
                    name TEXT NOT NULL,
                    logo TEXT,
                    league TEXT NOT NULL CHECK (league IN ('2v2', '4v4', '5v5')),
                    created_at TIMESTAMP DEFAULT NOW()
                );
                
                -- Create players table
                CREATE TABLE players (
                    id SERIAL PRIMARY KEY,
                    name TEXT NOT NULL,
                    image TEXT,
                    gender TEXT NOT NULL CHECK (gender IN ('male', 'female', 'other')),
                    position TEXT NOT NULL CHECK (position IN ('wing spiker', 'middle blocker', 'setter', 'libero', 'defensive specialist', 'all rounder')),
                    team_id INTEGER REFERENCES teams(id),
                    created_at TIMESTAMP DEFAULT NOW()
                );
                
                -- Create transfers table
                CREATE TABLE transfers (
                    id SERIAL PRIMARY KEY,
                    player_id INTEGER REFERENCES players(id),
                    from_team_id INTEGER REFERENCES teams(id),
                    to_team_id INTEGER REFERENCES teams(id),
                    created_at TIMESTAMP DEFAULT NOW()
                );
                
                -- Create matches table
                CREATE TABLE matches (
                    id SERIAL PRIMARY KEY,
                    team1_id INTEGER REFERENCES teams(id),
                    team1_score INTEGER NOT NULL,
                    team2_id INTEGER REFERENCES teams(id),
                    team2_score INTEGER NOT NULL,
                    match_date DATE NOT NULL,
                    created_at TIMESTAMP DEFAULT NOW()
                );
                
                6. Enable Row Level Security (RLS) and set up policies for public access (or customize as needed)
                
                7. Set up storage policies for the volleyball-images bucket:
                   - Allow public read access
                   - Allow authenticated uploads (or public if needed)
                
                8. Your volleyball database with image upload is ready to use!
            `);
        }
    </script>
</body>
</html>
